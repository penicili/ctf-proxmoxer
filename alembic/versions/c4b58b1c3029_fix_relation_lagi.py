"""fix relation lagi

Revision ID: c4b58b1c3029
Revises: 3fafcb6a3c53
Create Date: 2025-12-13 11:22:35.100705

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa


# revision identifiers, used by Alembic.
revision: str = 'c4b58b1c3029'
down_revision: Union[str, Sequence[str], None] = '3fafcb6a3c53'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('levels',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('name', sa.String(length=200), nullable=False),
    sa.Column('category', sa.Enum('AccessControl', 'Cryptography', 'Injection', 'InsecureDesign', 'Misconfiguration', 'OutdatedComponents', 'AuthenticationFailures', 'IntegrityFailures', 'LoggingFailures', 'SSRF', name='categoryenum'), nullable=False),
    sa.Column('difficulty', sa.Enum('EASY', 'MEDIUM', 'HARD', name='difficultyenum'), nullable=False),
    sa.Column('description', sa.Text(), nullable=True),
    sa.Column('points', sa.Integer(), nullable=False),
    sa.Column('template_url', sa.String(length=255), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('updated_at', sa.DateTime(), nullable=False),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_levels_category'), 'levels', ['category'], unique=False)
    op.create_index(op.f('ix_levels_difficulty'), 'levels', ['difficulty'], unique=False)
    op.create_index(op.f('ix_levels_id'), 'levels', ['id'], unique=False)
    op.create_index(op.f('ix_levels_is_active'), 'levels', ['is_active'], unique=False)
    op.create_index(op.f('ix_levels_name'), 'levels', ['name'], unique=True)
    op.create_table('challenges',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('level_id', sa.Integer(), nullable=False),
    sa.Column('team', sa.String(length=100), nullable=False),
    sa.Column('flag', sa.String(length=255), nullable=True),
    sa.Column('flag_submitted', sa.Boolean(), nullable=False),
    sa.Column('flag_submitted_at', sa.TIMESTAMP(), nullable=True),
    sa.Column('is_active', sa.Boolean(), nullable=False),
    sa.Column('created_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=False),
    sa.Column('updated_at', sa.TIMESTAMP(), server_default=sa.text('now()'), nullable=False),
    sa.ForeignKeyConstraint(['level_id'], ['levels.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id')
    )
    op.create_index(op.f('ix_challenges_flag'), 'challenges', ['flag'], unique=True)
    op.create_index(op.f('ix_challenges_id'), 'challenges', ['id'], unique=False)
    op.create_index(op.f('ix_challenges_is_active'), 'challenges', ['is_active'], unique=False)
    op.create_index(op.f('ix_challenges_level_id'), 'challenges', ['level_id'], unique=False)
    op.create_index(op.f('ix_challenges_team'), 'challenges', ['team'], unique=False)
    op.create_table('deployments',
    sa.Column('id', sa.Integer(), nullable=False),
    sa.Column('challenge_id', sa.Integer(), nullable=False),
    sa.Column('vm_id', sa.Integer(), nullable=True),
    sa.Column('vm_name', sa.String(length=100), nullable=True),
    sa.Column('vm_ip', sa.String(length=45), nullable=True),
    sa.Column('status', sa.Enum('PENDING', 'CREATING', 'RUNNING', 'STOPPED', 'ERROR', 'TERMINATING', 'TERMINATED', name='deploymentstatus'), nullable=False),
    sa.Column('error_message', sa.Text(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('started_at', sa.DateTime(), nullable=True),
    sa.Column('stopped_at', sa.DateTime(), nullable=True),
    sa.Column('terminated_at', sa.DateTime(), nullable=True),
    sa.ForeignKeyConstraint(['challenge_id'], ['challenges.id'], ondelete='CASCADE'),
    sa.PrimaryKeyConstraint('id'),
    sa.UniqueConstraint('vm_name')
    )
    op.create_index(op.f('ix_deployments_challenge_id'), 'deployments', ['challenge_id'], unique=True)
    op.create_index(op.f('ix_deployments_id'), 'deployments', ['id'], unique=False)
    op.create_index(op.f('ix_deployments_status'), 'deployments', ['status'], unique=False)
    op.create_index(op.f('ix_deployments_vm_id'), 'deployments', ['vm_id'], unique=True)
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f('ix_deployments_vm_id'), table_name='deployments')
    op.drop_index(op.f('ix_deployments_status'), table_name='deployments')
    op.drop_index(op.f('ix_deployments_id'), table_name='deployments')
    op.drop_index(op.f('ix_deployments_challenge_id'), table_name='deployments')
    op.drop_table('deployments')
    op.drop_index(op.f('ix_challenges_team'), table_name='challenges')
    op.drop_index(op.f('ix_challenges_level_id'), table_name='challenges')
    op.drop_index(op.f('ix_challenges_is_active'), table_name='challenges')
    op.drop_index(op.f('ix_challenges_id'), table_name='challenges')
    op.drop_index(op.f('ix_challenges_flag'), table_name='challenges')
    op.drop_table('challenges')
    op.drop_index(op.f('ix_levels_name'), table_name='levels')
    op.drop_index(op.f('ix_levels_is_active'), table_name='levels')
    op.drop_index(op.f('ix_levels_id'), table_name='levels')
    op.drop_index(op.f('ix_levels_difficulty'), table_name='levels')
    op.drop_index(op.f('ix_levels_category'), table_name='levels')
    op.drop_table('levels')
    # ### end Alembic commands ###
